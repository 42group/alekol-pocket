
#include <FreeRTOS.h>
#include <freertos/task.h>
#include <freertos/semphr.h>
#include "display.h"

extern SemaphoreHandle_t   mutex;

const unsigned char eyes[] = {
	// 'logo, 30x23px
	0x03, 0xc0, 0x0f, 0x00, 0x0f, 0xf0, 0x3f, 0xc0, 0x3f, 0xf8, 0x7f, 0xf0, 0x3f, 0xfc, 0xff, 0xf0, 
	0x7f, 0xfc, 0xff, 0xf8, 0x7f, 0xfd, 0xff, 0xf8, 0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 
	0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 
	0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 
	0xff, 0xfd, 0xff, 0xfc, 0xff, 0xfd, 0xff, 0xfc, 0x7f, 0xfd, 0xff, 0xf8, 0x7f, 0xfc, 0xff, 0xf8, 
	0x3f, 0xfc, 0xff, 0xf0, 0x1f, 0xf8, 0x7f, 0xe0, 0x07, 0xe0, 0x1f, 0x80
};

const unsigned char pupils[] = {
	// 'pupile, 30x23px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x38, 0x00, 0x3e, 0x00, 0x7c, 0x00, 0x7b, 0x00, 0xf6, 0x00, 
	0x79, 0x00, 0xf2, 0x00, 0x7d, 0x00, 0xfa, 0x00, 0x7f, 0x00, 0xfe, 0x00, 0x7f, 0x00, 0xfe, 0x00, 
	0x7f, 0x00, 0xfe, 0x00, 0x7f, 0x00, 0xfe, 0x00, 0x7f, 0x00, 0xfe, 0x00, 0x7f, 0x00, 0xfe, 0x00, 
	0x3f, 0x00, 0x7e, 0x00, 0x1e, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void    logo_animation(t_display *display, bool right)
{
    ssd1306_fill_rectangle(&display->dev, display->buffer, 0, 0, 30,
                           DISPLAY_HEIGHT, OLED_COLOR_BLACK);
    if (right) {
        int x = 0;
        while (x <= 6) {
            drawBitmap(display, 0, 0, eyes, 30, 23, OLED_COLOR_WHITE);
            drawBitmap(display, x++, 0, pupils, 30, 23, OLED_COLOR_BLACK);
            refresh_display(display);
            vTaskDelay(100 / portTICK_RATE_MS);
        }
    }
    else {
        int x = 6;
        while (x >= 0) {
            drawBitmap(display, 0, 0, eyes, 30, 23, OLED_COLOR_WHITE);
            drawBitmap(display, x--, 0, pupils, 30, 23, OLED_COLOR_BLACK);
            refresh_display(display);
            vTaskDelay(100 / portTICK_RATE_MS);
        }
    }
}

void    logo_animation_task(t_display *display)
{
    ssd1306_fill_rectangle(&display->dev, display->buffer, 0, 0, 30,
                           DISPLAY_HEIGHT, OLED_COLOR_BLACK);
    bool    right = true;

    while (1) {
        xSemaphoreTake(mutex, portMAX_DELAY);
        logo_animation(display, right);
        xSemaphoreGive(mutex);
        right = right == true ? false : true;
        vTaskDelay(2000 / portTICK_RATE_MS);
    }
}
